#!/bin/bash
# htpasswd - .htpasswdファイルを作成（パスワード自動生成対応）
#
# カレントディレクトリに .htpasswd を MD5ハッシュで作成する。
# パスワード未指定の場合、5段階の強度でパスワードを自動生成し、
# fzfで選択できる。
#
# Usage:
#   htpasswd <username> [password]

HTPASSWD_CMD=/usr/sbin/htpasswd

if [[ -z "$1" ]]; then
  echo "Usage: htpasswd <username> [password]"
  exit 1
fi

username="$1"
password="$2"

if [[ -z "$password" ]]; then
  # 5段階の強度でパスワードを生成
  p1=$(LC_ALL=C tr -dc '0-9' < /dev/urandom | head -c 6)
  p2=$(LC_ALL=C tr -dc 'a-z0-9' < /dev/urandom | head -c 6)
  p3=$(LC_ALL=C tr -dc 'a-z0-9' < /dev/urandom | head -c 8)
  p4=$(LC_ALL=C tr -dc 'A-Za-z0-9' < /dev/urandom | head -c 12)
  p5=$(LC_ALL=C tr -dc 'A-Za-z0-9!@#%&*+?' < /dev/urandom | head -c 16)

  selected=$(printf "%s\n" \
    "1. 弱     [数字のみ 6桁]          : $p1" \
    "2. やや弱 [英数字 6桁]            : $p2" \
    "3. 普通   [英数字 8桁]            : $p3" \
    "4. 強     [英大小文字+数字 12桁]   : $p4" \
    "5. 最強   [英大小+数字+記号 16桁]  : $p5" \
    | fzf --height 15% --reverse --header "パスワード強度を選択")

  [[ -z "$selected" ]] && exit 0

  # 選択行の最後の ": " 以降がパスワード
  password="${selected##*: }"
fi

"$HTPASSWD_CMD" -cbm .htpasswd "$username" "$password"

echo ""
echo "パスワード: $password"
echo "$password" | tr -d '\n' | pbcopy
echo "(クリップボードにコピーしました)"
